<!DOCTYPE html>
<html>
<head>
  <title>AutoPreview - Define Variable</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 { color: #333; margin-bottom: 10px; }
    h2 { color: #666; font-size: 1.1em; margin-top: 0; }
    .error-box {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .error-box code {
      background: #f8f9fa;
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: bold;
      color: #d63384;
    }
    form {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
    }
    select, input[type="text"], textarea {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    select:focus, input[type="text"]:focus, textarea:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
    }
    textarea {
      min-height: 80px;
      font-family: monospace;
    }
    button {
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      width: 100%;
    }
    button:hover {
      background: #0056b3;
    }
    .existing-vars {
      background: #e9ecef;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .existing-vars h3 {
      margin-top: 0;
      font-size: 0.9em;
      color: #666;
    }
    .existing-vars ul {
      margin: 0;
      padding-left: 20px;
    }
    .existing-vars li {
      margin-bottom: 5px;
      font-family: monospace;
      font-size: 0.9em;
    }
    .type-hint {
      font-size: 0.85em;
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h1>AutoPreview</h1>
  <h2>Template: <%= @template_path %></h2>

  <div class="error-box">
    <strong>Missing Variable:</strong> The template requires a variable named <code><%= @missing_variable %></code>.
    <br>Please provide a type and value below.
  </div>

  <% if @existing_vars.present? && @existing_vars.keys.any? %>
    <div class="existing-vars">
      <h3>Already defined variables:</h3>
      <ul>
        <% @existing_vars.each do |name, config| %>
          <li><strong><%= name %></strong> (<%= config[:type] %>): <%= config[:value].inspect %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <% is_predicate = @missing_variable.to_s.end_with?("?") %>
  <% default_type = is_predicate ? "Boolean" : "String" %>

  <%= form_tag url_for(action: :show), method: :get do %>
    <%= hidden_field_tag :template, @template_path %>
    <%= hidden_field_tag :controller_context, @controller_context %>

    <%# Preserve existing variables %>
    <% if @existing_vars.present? %>
      <% @existing_vars.each do |name, config| %>
        <%= hidden_field_tag "vars[#{name}][type]", config[:type] %>
        <%= hidden_field_tag "vars[#{name}][value]", config[:value] %>
      <% end %>
    <% end %>

    <div class="form-group">
      <label for="var_type">Type for <code><%= @missing_variable %></code></label>
      <%= select_tag "vars[#{@missing_variable}][type]",
                     options_for_select(@ruby_types, default_type),
                     id: "var_type",
                     onchange: "updateValueHint(this.value)" %>
      <p class="type-hint" id="type-hint">
        <%= is_predicate ? 'Select true or false for this predicate helper' : 'Enter any text value' %>
      </p>
    </div>

    <div class="form-group" id="bool-group" style="<%= is_predicate ? '' : 'display:none;' %>">
      <label>Boolean value</label>
      <div style="display:flex; gap:20px; padding:8px 0;">
        <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-weight:normal;">
          <input type="radio" name="bool_choice" value="true" onchange="setBooleanValue('true')" <%= 'checked' if is_predicate %>>
          True
        </label>
        <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-weight:normal;">
          <input type="radio" name="bool_choice" value="false" onchange="setBooleanValue('false')">
          False
        </label>
      </div>
    </div>

    <div class="form-group" id="value-group" style="<%= is_predicate ? 'display:none;' : '' %>">
      <label for="var_value">Value</label>
      <%= text_area_tag "vars[#{@missing_variable}][value]",
                        nil,
                        id: "var_value",
                        placeholder: is_predicate ? "true" : "Enter value..." %>
    </div>

    <div class="form-group" id="factory-group" style="display: none;">
      <label for="factory_select">Factory</label>
      <select id="factory_select" onchange="updateFactoryValue()">
        <option value="">Select a factory...</option>
        <% @factories.each do |factory| %>
          <option value="<%= factory[:name] %>"><%= factory[:name] %></option>
          <% factory[:traits].each do |trait| %>
            <option value="<%= factory[:name] %>:<%= trait %>"><%= factory[:name] %>:<%= trait %></option>
          <% end %>
        <% end %>
      </select>
      <p class="type-hint">Select a factory to create a record (rendered in a rolled-back transaction)</p>
    </div>

    <%= submit_tag "Continue Preview", data: { disable_with: "Loading..." } %>
  <% end %>

  <script>
    function setBooleanValue(value) {
      const valueInput = document.getElementById('var_value');
      valueInput.value = value;
    }

    function updateValueHint(type) {
      const hint = document.getElementById('type-hint');
      const valueInput = document.getElementById('var_value');
      const valueGroup = document.getElementById('value-group');
      const factoryGroup = document.getElementById('factory-group');
      const factorySelect = document.getElementById('factory_select');

      const hints = {
        'String': 'Enter any text value',
        'Integer': 'Enter a whole number (e.g., 42)',
        'Float': 'Enter a decimal number (e.g., 3.14)',
        'Boolean': 'Enter "true", "1", "yes" for true; anything else for false',
        'Array': 'Enter JSON array (e.g., ["a", "b", "c"] or [1, 2, 3])',
        'Hash': 'Enter JSON object (e.g., {"key": "value"})',
        'NilClass': 'Value will be nil (input ignored)',
        'Factory': 'Select a FactoryBot factory'
      };

      const placeholders = {
        'String': 'Hello World',
        'Integer': '42',
        'Float': '3.14',
        'Boolean': 'true',
        'Array': '["item1", "item2"]',
        'Hash': '{"key": "value"}',
        'NilClass': '(nil)',
        'Factory': 'user'
      };

      hint.textContent = hints[type] || 'Enter a value';
      valueInput.placeholder = placeholders[type] || 'Enter value...';

      const boolGroup = document.getElementById('bool-group');

      if (type === 'Boolean') {
        valueGroup.style.display = 'none';
        factoryGroup.style.display = 'none';
        boolGroup.style.display = 'block';
        valueInput.disabled = false;
      } else if (type === 'Factory') {
        boolGroup.style.display = 'none';
        valueGroup.style.display = 'none';
        factoryGroup.style.display = 'block';
        // Don't disable - the value still needs to be submitted
        valueInput.disabled = false;
      } else if (type === 'NilClass') {
        valueGroup.style.display = 'block';
        factoryGroup.style.display = 'none';
        boolGroup.style.display = 'none';
        valueInput.disabled = true;
        valueInput.value = '';
      } else {
        valueGroup.style.display = 'block';
        factoryGroup.style.display = 'none';
        boolGroup.style.display = 'none';
        valueInput.disabled = false;
      }
    }

    function updateFactoryValue() {
      const factorySelect = document.getElementById('factory_select');
      const valueInput = document.getElementById('var_value');
      valueInput.value = factorySelect.value;
    }
  </script>
</body>
</html>
