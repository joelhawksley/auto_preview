<style>
  .auto-preview-fab {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 52px;
    height: 52px;
    border-radius: 50%;
    background: #2563eb;
    color: #fff;
    border: none;
    cursor: pointer;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
    font-size: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  }

  .auto-preview-fab:hover {
    background: #1d4ed8;
  }

  .auto-preview-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.45);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10001;
  }

  .auto-preview-overlay.open {
    display: flex;
  }

  .auto-preview-panel {
    background: #fff;
    width: 92vw;
    max-width: 640px;
    max-height: 85vh;
    border-radius: 14px;
    overflow: hidden;
    box-shadow: 0 25px 60px rgba(0, 0, 0, 0.35);
    display: flex;
    flex-direction: column;
  }

  .auto-preview-panel-header {
    padding: 16px 20px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #f8fafc;
  }

  .auto-preview-panel-header h2 {
    margin: 0;
    font-size: 18px;
    color: #111827;
  }

  .auto-preview-close-btn {
    border: none;
    background: none;
    font-size: 24px;
    cursor: pointer;
    color: #6b7280;
  }

  .auto-preview-panel-body {
    padding: 18px 20px 24px;
    overflow: auto;
  }

  .auto-preview-template-info {
    background: #eef2ff;
    padding: 10px 12px;
    border-radius: 8px;
    font-size: 13px;
    margin-bottom: 16px;
    color: #3730a3;
  }

  .auto-preview-template-info code {
    background: rgba(255, 255, 255, 0.7);
    padding: 2px 6px;
    border-radius: 4px;
  }

  .auto-preview-var {
    padding: 12px;
    border-radius: 10px;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    margin-bottom: 12px;
  }

  .auto-preview-var-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  .auto-preview-var-name {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 13px;
    color: #111827;
    font-weight: 600;
  }

  .auto-preview-type-select,
  .auto-preview-value-input {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
    box-sizing: border-box;
    margin-top: 6px;
  }

  .auto-preview-bool-group {
    display: flex;
    gap: 20px;
    margin-top: 8px;
    padding: 8px 0;
  }

  .auto-preview-bool-group label {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    font-size: 14px;
  }

  .auto-preview-submit {
    width: 100%;
    margin-top: 16px;
    padding: 12px 16px;
    border: none;
    border-radius: 8px;
    background: #2563eb;
    color: #fff;
    font-size: 15px;
    cursor: pointer;
  }

  .auto-preview-empty {
    text-align: center;
    color: #6b7280;
    padding: 18px 0;
  }
</style>

<button class="auto-preview-fab" type="button" onclick="AutoPreviewOverlay.open()" aria-label="Edit preview variables">
  ⚙️
</button>

<div class="auto-preview-overlay" id="autoPreviewOverlay" onclick="AutoPreviewOverlay.backdrop(event)">
  <div class="auto-preview-panel" onclick="event.stopPropagation()">
    <div class="auto-preview-panel-header">
      <h2>Edit Preview Variables</h2>
      <button class="auto-preview-close-btn" type="button" onclick="AutoPreviewOverlay.close()">&times;</button>
    </div>
    <div class="auto-preview-panel-body">
      <div class="auto-preview-template-info">
        Template: <code><%= template_path %></code>
      </div>

      <%= form_tag url_for(action: :show), method: :get, id: "autoPreviewEditForm" do %>
        <%= hidden_field_tag :template, template_path %>
        <%= hidden_field_tag :controller_context, controller_context %>

        <% vars = existing_vars.respond_to?(:to_unsafe_h) ? existing_vars.to_unsafe_h : (existing_vars || {}) %>
        <% if vars.present? %>
          <% vars.each do |name, config| %>
            <% cfg = config.respond_to?(:to_unsafe_h) ? config.to_unsafe_h : config %>
            <% cfg = cfg || {} %>
            <% is_predicate = name.to_s.end_with?("?") %>
            <% current_type = cfg["type"] || cfg[:type] || (is_predicate ? "Boolean" : "String") %>
            <% current_value = cfg["value"] || cfg[:value] || "" %>
            <% param_key = name.to_s.parameterize %>

            <div class="auto-preview-var">
              <div class="auto-preview-var-header">
                <span class="auto-preview-var-name"><%= name %></span>
              </div>

              <select class="auto-preview-type-select"
                      name="vars[<%= name %>][type]"
                      onchange="AutoPreviewOverlay.onTypeChange('<%= param_key %>', this.value)">
                <% ruby_types.each do |type| %>
                  <option value="<%= type %>" <%= 'selected' if type == current_type %>><%= type %></option>
                <% end %>
              </select>

              <input class="auto-preview-value-input"
                     type="text"
                     name="vars[<%= name %>][value]"
                     id="auto_preview_value_<%= param_key %>"
                     value="<%= current_value %>"
                     style="<%= current_type == 'Boolean' ? 'display:none;' : '' %>">

              <div class="auto-preview-bool-group" id="auto_preview_bool_<%= param_key %>" style="<%= current_type == 'Boolean' ? '' : 'display:none;' %>">
                <label>
                  <input type="radio" name="bool_<%= param_key %>" value="true"
                         onchange="AutoPreviewOverlay.setBoolean('<%= param_key %>', 'true')"
                         <%= 'checked' if current_value.to_s == 'true' %>>
                  True
                </label>
                <label>
                  <input type="radio" name="bool_<%= param_key %>" value="false"
                         onchange="AutoPreviewOverlay.setBoolean('<%= param_key %>', 'false')"
                         <%= 'checked' if current_value.to_s == 'false' %>>
                  False
                </label>
              </div>
            </div>
          <% end %>

          <button class="auto-preview-submit" type="submit">Update Preview</button>
        <% else %>
          <div class="auto-preview-empty">No variables defined yet.</div>
        <% end %>
      <% end %>
    </div>
  </div>
</div>

<script>
  window.AutoPreviewOverlay = {
    open() {
      document.getElementById('autoPreviewOverlay').classList.add('open');
    },
    close() {
      document.getElementById('autoPreviewOverlay').classList.remove('open');
    },
    backdrop(event) {
      if (event.target.id === 'autoPreviewOverlay') {
        this.close();
      }
    },
    onTypeChange(paramKey, type) {
      const valueInput = document.getElementById('auto_preview_value_' + paramKey);
      const boolGroup = document.getElementById('auto_preview_bool_' + paramKey);

      if (type === 'Boolean') {
        valueInput.style.display = 'none';
        boolGroup.style.display = 'flex';
      } else {
        valueInput.style.display = 'block';
        boolGroup.style.display = 'none';
      }
    },
    setBoolean(paramKey, value) {
      const valueInput = document.getElementById('auto_preview_value_' + paramKey);
      valueInput.value = value;
    }
  };

  document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape') {
      AutoPreviewOverlay.close();
    }
  });
</script>